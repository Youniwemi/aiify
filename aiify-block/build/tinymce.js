(()=>{"use strict";const e=window.wp.element,t=window.wp.i18n,n=window.wp.blockEditor,i=window.wp.components,a=wp.data.select("core/block-editor"),o=wp.data.dispatch("core/block-editor"),r=a.getBlock,l=a.getBlockIndex,c=o.insertBlock,s=o.updateBlockAttributes,d=(o.updateBlock,a.getBlockRootClientId),u=(o.insertAfterBlock,o.insertBeforeBlock,o.removeBlocks),m=o.removeBlock,p=wp.blocks.switchToBlockType,g=wp.blocks.createBlock,f=wp.data.dispatch("core/notices").createErrorNotice,w=["core/paragraph","core/heading","core/group","core/code","core/pullquote","core/quote","core/verse","core/list","core/list-item"],y=e=>{u(r(e).innerBlocks.map((e=>e.clientId)))},h=e=>(e=(e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>')).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")).replace(/\*(.*?)\*/g,"<em>$1</em>"),v=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(e){case"core/quote":case"core/pullquote":var i=t.split(" - ");i.length>1&&(n.citation=i.pop(),t=i.join(" - ")),n.value=h(t);break;default:n.content=h(t)}return g(e,n)},b=async(e,t,n,i)=>{var a=v(e,t.trimStart(),i);const o=r(n);o.innerBlocks;var l=o.innerBlocks?o.innerBlocks.length:0;return await c(a,l,n),await r(n).innerBlocks[l]},k=e=>"- "==e.slice(0,2)||"- "==e||"-"==e,E=e=>Object.keys(e).map(((e,t,n)=>({label:e,value:n[t]}))),x=e=>{let{idBlock:n,prompt:i,context:a,keywords:o,edit:u,setAttributes:w,insertAfter:E,onDone:x,isTiny:C=null,injectContent:_=null}=e;if(null==i)return;var B=new FormData;B.append("action","open_ai");const{style:S,tone:I,language:A,maxWords:M,nonce:N}=window.aiify;B.append("openai_nonce",N),B.append("style",S),B.append("tone",I),B.append("language",A),B.append("maxWords",M),u&&B.append("edit",u),B.append("prompt",i),a&&B.append("context",a),o&&B.append("keywords",o);var D=new URLSearchParams(B).toString(),P=new EventSource(window.ajaxurl+"?"+D),q=C?null:r(n),T=C?null:"core/group"==q.name||"core/list"==q.name,$="",j={},F=!1,O=!1,W=!1,L=!1,H="core/paragraph",R="",Z=n,G=!0,J=!0,z=!1,U=!1,V=!1,K=!1,Q=!1,X=null;const Y="after"==E;var ee=!0;const te=()=>{console.log("Answer completed",$),x&&x()};P.onmessage=async function(e){if(ee){ee=!1;const t=JSON.parse(e.data);if(console.log("Full opts",e.data),"messages"in t){var i=t.messages.map((e=>e.content)).join("\n\n");window.aiify.latestPrompt=i}return"prompt"in t&&(console.log("Prompt",t.prompt),window.aiify.latestPrompt=t.prompt),void("error"in t&&f(t.error.message,{type:"snackbar",explicitDismiss:!0}))}if("[DONE]"==e.data){if(P.close(),E)m(X.innerBlocks[0].clientId);else if(u)return"core/paragraph"!==H&&p(r(Z),H),s(Z,{content:h(R.trimStart()),name}),void te();return C?_(H,h(R),j):b(H,R,Z,j),void te()}var a="";try{var o=JSON.parse(e.data);if("text"in o.choices[0])a=o.choices[0].text;else{if(!("content"in o.choices[0].delta))return;a=o.choices[0].delta.content}}catch(e){return}if($+=a,!G||(G=!1,"\n\n"!=a&&""!=a)){if(u)if(E)0==Q&&(X=await async function(e,n,i,a){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};var r=null;if("core/group"==e){const n=g("core/paragraph",{content:(0,t.__)("Please wait...","aiify")});r=g(e,{layout:{type:"constrained"},tagName:"div"},[n])}else if(n&&k(n)){e="core/list";var s=n.split("\n").map((e=>g("core/list-item",{content:e.substr(2)})));r=g(e,{},s)}else r=v(e,n.trimStart(),o);var u=l(i),m=d(i);return console.log("Block index  ",i,u),await c(r,a?u+1:u,m),r}("core/group",null,Z,Y),Z=n=X.clientId,Q=!0);else{if(!T)return"##"==a.slice(0,2)?(H="core/heading",void(j={level:a.length})):void(R+=a);0==K&&(y(n),K=!0)}if(0==F){if("\n"==a.slice(0,1)||"\n"==a.slice(0,2))return;F=!0,j={},">"==a.slice(0,1)||"&gt;"==a.slice(0,4)?(H="core/pullquote",Z=n,V=!0,U=!1,L=!1):"##"==a.slice(0,2)||" ##"==a.slice(0,3)?(H="core/heading",Z=n,U=!0,L=!1,V=!1,j={level:a.trim("").length}):k(a)?(0==L&&(L=!0,W=await b("core/list","",Z),Z=W.clientId,J=!0),z=!0,U=!1,V=!1,H="core/list-item"):(H="core/paragraph",Z=n,L=!1,U=!1,V=!1)}else"\n\n"!=a.slice(-2)&&"\n\n"!=a.slice(-2)&&"\n"!=a.slice(-1)&&"\n"!=a.slice(-1)||(O=!0);z||U||V?(z=!1,U=!1,V=!1):R+=a,O&&(L&&J?null==C?(r(W.clientId).innerBlocks[0].attributes.content=h(R.trimStart()),J=!1):_("core/list-item",h(R.trimStart()),{first:!0}):C?_(H,h(R),j):await b(H,R,Z,j),R="",O=!1,F=!1),w({reply:$})}},P.onerror=function(e,t){f("Error while calling AI API",{type:"snackbar",explicitDismiss:!0}),P.close(),te()}},C=(0,e.createElement)("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 553.84 552.02"},(0,e.createElement)("path",{fill:"#6f52a2",d:"M.67,.18H371.96c99.34,0,180,80.66,180,180v371.29H180.67C81.32,551.47,.67,470.82,.67,371.47V.18H.67Z"}),(0,e.createElement)("g",null,(0,e.createElement)("path",{fill:"#fff",d:"M243.54,394.07c-23.45,0-43.15-8.03-59.11-24.1-15.96-16.07-23.94-35.83-23.94-59.28s7.98-43.15,23.94-59.11c15.96-15.96,35.66-23.94,59.11-23.94s43.2,7.98,59.28,23.94c16.06,15.96,24.1,35.66,24.1,59.11v60.9c0,6.52-2.07,11.78-6.19,15.8-4.13,4.01-9.45,6.02-15.96,6.02s-11.78-2.01-15.8-6.02c-4.02-4.02-6.02-9.28-6.02-15.8v-60.9c0-10.85-3.86-20.08-11.56-27.68-7.71-7.6-16.99-11.4-27.85-11.4s-20.08,3.8-27.68,11.4c-7.6,7.61-11.4,16.83-11.4,27.68s3.8,20.14,11.4,27.85c7.6,7.71,16.82,11.56,27.68,11.56,6.51,0,11.83,2.01,15.96,6.03,4.12,4.02,6.19,9.28,6.19,15.79s-2.07,11.84-6.19,15.96c-4.13,4.13-9.45,6.19-15.96,6.19Z"}),(0,e.createElement)("path",{fill:"#fff",d:"M385.37,165.93c5.32,5.33,7.98,11.68,7.98,19.06s-2.66,13.74-7.98,19.05c-5.32,5.32-11.67,7.98-19.05,7.98s-13.74-2.66-19.05-7.98c-5.32-5.32-7.98-11.67-7.98-19.05s2.66-13.73,7.98-19.06c5.32-5.32,11.67-7.98,19.05-7.98s13.73,2.66,19.05,7.98Zm3.09,83.54c0-14.54-7.38-21.82-22.15-21.82-6.52,0-11.78,2.01-15.8,6.02-4.02,4.02-6.03,9.28-6.03,15.79v122.13c0,6.52,2.01,11.78,6.03,15.8,4.01,4.01,9.28,6.02,15.8,6.02s11.83-2.01,15.96-6.02c4.12-4.02,6.19-9.28,6.19-15.8v-122.13Z"})));function _(a){let{attributes:o,setAttributes:r,isTiny:l=null,injectContent:c=null,onDone:s=(()=>null)}=a;return function(a){const o=l?[]:(0,n.useBlockProps)(),[d,u]=(0,e.useState)(!1),{prompts:m}=window.aiify;if(l){var[a,p]=(0,e.useState)({});r=e=>{p({...a,...e})}}var g=l||o.id.split("block-")[1];const f="prompt-"+g,w="context-"+g,h="keywords-"+g,v=l?null:(0,e.createElement)(n.InnerBlocks,{allowedBlocks:["core/image","core/group","core/paragraph","core/quote","core/code","core/pullquote","core/list","core/list-item","core/heading","core/verse","wp-gb/inner-blocks"]}),b=l?null:(0,e.createElement)(i.Button,{disabled:d,variant:"default",onClick:()=>y(g),text:(0,t.__)("Clear","aiify")});return(0,e.createElement)("div",o,(0,e.createElement)(i.SelectControl,{label:(0,t.__)("Select a content type","aiify"),onChange:e=>{const t=e+' "['+m[e]+']"';r({prompt:t});const n=document.querySelector('[data-id="'+f+'"]');n&&setTimeout((()=>n.focus()),200),console.log()},options:E(m)}),(0,e.createElement)(i.TextareaControl,{"data-id":f,autoFocus:!0,placeholder:(0,t.__)("What do you want to write today?","aiify"),label:"",rows:2,value:a.prompt,onChange:e=>r({prompt:e}),onFocus:e=>{const t=e.target,n=t.value.match(/\"\[([^\]]+)\]\"/);if(n){const e=n.index+1,i=e+n[1].length+2;t.selectionStart=e,t.selectionEnd=i}}}),(0,e.createElement)(i.TextareaControl,{"data-id":w,placeholder:(0,t.__)("Add key information to include in the content?\n- Information 1\n- Information 2","aiify"),label:"",rows:4,value:a.context,onChange:e=>r({context:e})}),(0,e.createElement)(i.TextareaControl,{"data-id":h,placeholder:(0,t.__)("Add keywords to highlight in the content? (comma separated keywords)","aiify"),label:"",rows:1,value:a.keywords,onChange:e=>r({keywords:e})}),(0,e.createElement)(i.ButtonGroup,{textAlign:"right"},(0,e.createElement)(i.Button,{isBusy:d,disabled:d||null==a.prompt,variant:"primary",onClick:()=>{u(!0),x({prompt:a.prompt,context:a.context,keywords:a.keywords,idBlock:g,setAttributes:r,onDone:()=>{u(!1),s()},isTiny:l,injectContent:c})},text:(0,t.__)("Write","aiify")}),b),v)}(o)}(0,e.createElement)("svg",{width:"135",height:"140",viewBox:"0 0 135 140",xmlns:"http://www.w3.org/2000/svg",fill:"#fff"},(0,e.createElement)("rect",{y:"10",width:"15",height:"120",rx:"6"},(0,e.createElement)("animate",{attributeName:"height",begin:"0.5s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,e.createElement)("animate",{attributeName:"y",begin:"0.5s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,e.createElement)("rect",{x:"30",y:"10",width:"15",height:"120",rx:"6"},(0,e.createElement)("animate",{attributeName:"height",begin:"0.25s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,e.createElement)("animate",{attributeName:"y",begin:"0.25s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,e.createElement)("rect",{x:"60",width:"15",height:"140",rx:"6"},(0,e.createElement)("animate",{attributeName:"height",begin:"0s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,e.createElement)("animate",{attributeName:"y",begin:"0s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,e.createElement)("rect",{x:"90",y:"10",width:"15",height:"120",rx:"6"},(0,e.createElement)("animate",{attributeName:"height",begin:"0.25s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,e.createElement)("animate",{attributeName:"y",begin:"0.25s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,e.createElement)("rect",{x:"120",y:"10",width:"15",height:"120",rx:"6"},(0,e.createElement)("animate",{attributeName:"height",begin:"0.5s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,e.createElement)("animate",{attributeName:"y",begin:"0.5s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"}))),window.wp.hooks;const B=window.wp.compose,S=n=>{const{styles:a,tones:o,maxWords:r,style:l,tone:c,languages:s,language:d,latestPrompt:u}=window.aiify,[m,p]=(0,e.useState)(parseInt(r)),[g,f]=(0,e.useState)(c),[w,y]=(0,e.useState)(l),[h,v]=(0,e.useState)(d);return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(i.RangeControl,{min:0,max:2e3,label:(0,t.__)("Max words to generate","aiify"),help:(0,t.__)("Do not exceed this value","aiify"),value:parseInt(m),onChange:e=>{window.aiify.maxWords=e,p(e)}}),(0,e.createElement)(i.SelectControl,{label:(0,t.__)("Select writing style","aiify"),onChange:e=>{window.aiify.style=e,y(e)},options:a,value:w}),(0,e.createElement)(i.SelectControl,{label:(0,t.__)("Select writing tone","aiify"),onChange:e=>{window.aiify.tone=e,f(e)},options:o,value:g}),(0,e.createElement)(i.SelectControl,{label:(0,t.__)("Select an output language","aiify"),onChange:e=>{window.aiify.language=e,v(e)},options:s,value:h}))};(0,B.createHigherOrderComponent)((a=>o=>{const{name:r,attributes:l,setAttributes:c}=o;if((e=>w.concat(["aiify/aiify"]).includes(e))(r)&&o.isSelected){const{latestPrompt:r}=window.aiify;return(0,e.createElement)(e.Fragment,null,(0,e.createElement)(a,o),(0,e.createElement)(n.InspectorControls,null,(0,e.createElement)(i.PanelBody,{icon:C,title:(0,t.__)("Aiify Settings","aiify")},(0,e.createElement)(S,o),(0,e.createElement)(i.TextareaControl,{label:(0,t.__)("Last Prompt","aiify"),rows:10,value:r,disabled:!0}))))}return(0,e.createElement)(a,o)}),"withPanelControl"),tinymce.create("tinymce.plugins.aiify",{init:function(t,n){n=n.replace("/aiify-block/build","/assets"),t.addCommand("aiify_me",(function(){window.aiifyDialog=t.windowManager.open({title:"Ask AI",items:{type:"container",html:"<div class='wp-core-ui' style='padding:1em;display:flex;' id='aiify_me' >Loading..</div>"},width:700,height:400,buttons:[{text:"Close",onclick:"close"}]});var n=!1;ReactDOM.render((0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{id:"aiify_prompt",style:{padding:".5em",flexBasis:"60%",flexGrow:1}},(0,e.createElement)(_,{isTiny:t.settings.id,onDone:()=>window.aiifyDialog.close(),attributes:{},injectContent:(e,i,a)=>{switch(n&&"core/list-item"!=e&&(t.insertContent("</ul>"),n=!1),e){case"core/heading":const e=a.level;i=`<h${e}>${i}</h${e}>`;break;case"core/list-item":a.first&&(t.insertContent("<ul>"),n=!0),i=`<li>${i}</li>`;break;case"core/quote":case"core/pullquote":i=`<blockquote>${i}</blockquote>`;break;default:i=`<p>${i}</p>`}t.insertContent(i)}})),(0,e.createElement)("div",{id:"aiify_panel",style:{padding:".5em",flexBasis:"40%",flexGrow:1}},(0,e.createElement)(S,null))),document.getElementById("aiify_me")),setTimeout((function(){window.aiifyDialog.$el.removeClass("mce-container"),window.aiifyDialog._items[0].$el.removeClass("mce-container").css({width:700,height:"auto"}).find(".mce-container-body").css({width:700,height:"auto"})}),500)})),t.addButton("aiify_action",{title:"Aiify Me",cmd:"aiify_me",image:n+"/img/icon.svg"})},createControl:function(e,t){return null},getInfo:function(){return{longname:"Aiify",author:"Instareza",authorurl:"http://www.wpaiify.com",infourl:"http://www.wpaiify.com",version:"1.4"}}}),tinymce.PluginManager.add("aiify",tinymce.plugins.aiify)})();
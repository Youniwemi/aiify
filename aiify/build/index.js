(()=>{"use strict";const e=window.wp.blocks,t=window.wp.hooks,n=window.wp.element,a=window.wp.i18n,r=window.wp.blockEditor,o=window.wp.components,i=wp.data.select("core/block-editor"),l=wp.data.dispatch("core/block-editor"),c=i.getBlock,s=i.getBlockIndex,d=l.insertBlock,u=l.updateBlockAttributes,m=(l.updateBlock,i.getBlockRootClientId),p=(l.insertAfterBlock,l.insertBeforeBlock,l.removeBlocks),g=l.removeBlock,f=wp.blocks.switchToBlockType,w=wp.blocks.createBlock,h=wp.data.dispatch("core/notices").createErrorNotice,b=["core/paragraph","core/heading","core/group","core/code","core/pullquote","core/quote","core/verse","core/list","core/list-item"],y=e=>{p(c(e).innerBlocks.map((e=>e.clientId)))},v=e=>(e=(e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>')).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")).replace(/\*(.*?)\*/g,"<em>$1</em>"),E=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(e){case"core/quote":case"core/pullquote":var a=t.split(" - ");a.length>1&&(n.citation=a.pop(),t=a.join(" - ")),n.value=v(t);break;default:n.content=v(t)}return w(e,n)},k=async(e,t,n,a)=>{var r=E(e,t.trimStart(),a);const o=c(n);o.innerBlocks;var i=o.innerBlocks?o.innerBlocks.length:0;return await d(r,i,n),await c(n).innerBlocks[i]},B=e=>"- "==e.slice(0,2)||"- "==e||"-"==e,C=e=>{let{idBlock:t,prompt:n,edit:r,setAttributes:o,insertAfter:i,onDone:l}=e;var p=new FormData;p.append("action","open_ai");const{style:b,tone:C,language:_,maxWords:x,nonce:S}=window.aiify;p.append("openai_nonce",S),p.append("style",b),p.append("tone",C),p.append("language",_),p.append("maxWords",x),r&&p.append("edit",r),p.append("prompt",n);var M=c(t),A="core/group"==M.name||"core/list"==M.name,N=new URLSearchParams(p).toString(),I=new EventSource(window.ajaxurl+"?"+N),F="",$={},q=!1,D=!1,T=!1,G=!1,P="core/paragraph",j="",O=t,W=!0,H=!0,R=!1,Z=!1,L=!1,J=!1,z=!1,U=null;const V="after"==i;var K=!0;const Q=()=>{console.log("Answer completed",F),l&&l()};I.onmessage=async function(e){if(K){K=!1,console.log(e);const t=JSON.parse(e.data);return"messages"in t&&console.log(t.messages.map((e=>e.content)).join("\n\n")),"prompt"in t&&console.log(t.prompt),void("error"in t&&h(t.error.message,{type:"snackbar",explicitDismiss:!0}))}if("[DONE]"==e.data){if(I.close(),i)g(U.innerBlocks[0].clientId);else if(r)return"core/paragraph"!==P&&f(c(O),P),u(O,{content:v(j.trimStart()),name}),void Q();return k(P,j,O,$),void Q()}var n=JSON.parse(e.data),l="";if("text"in n.choices[0])l=n.choices[0].text;else{if(!("content"in n.choices[0].delta))return;l=n.choices[0].delta.content}if(F+=l,!W||(W=!1,"\n\n"!=l)){if(r)if(i)0==z&&(U=await async function(e,t,n,r){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};var i=null;if("core/group"==e){const t=w("core/paragraph",{content:(0,a.__)("Please wait...","aiify")});i=w(e,{layout:{type:"constrained"},tagName:"div"},[t])}else if(t&&B(t)){e="core/list";var l=t.split("\n").map((e=>w("core/list-item",{content:e.substr(2)})));i=w(e,{},l)}else i=E(e,t.trimStart(),o);var c=s(n),u=m(n);return console.log("Block index  ",n,c),await d(i,r?c+1:c,u),i}("core/group",null,O,V),O=t=U.clientId,z=!0);else{if(!A)return"##"==l.slice(0,2)?(P="core/heading",void($={level:l.length})):void(j+=l);0==J&&(console.log("clearing"),y(t),J=!0)}0==q?(q=!0,$={},">"==l.slice(0,1)||"&gt;"==l.slice(0,4)?(P="core/pullquote",O=t,L=!0,Z=!1,G=!1):"##"==l.slice(0,2)?(P="core/heading",O=t,Z=!0,G=!1,L=!1,$={level:l.length}):B(l)?(0==G&&(G=!0,T=await k("core/list","",O),console.log("injected  list",T),O=T.clientId,H=!0),R=!0,Z=!1,L=!1,P="core/list-item"):(P="core/paragraph",O=t,G=!1,Z=!1,L=!1)):"\n\n"!=l.slice(-2)&&"\n"!=l.slice(-1)||(D=!0),R||Z||L?(R=!1,Z=!1,L=!1):j+=l,D&&(G&&H?(c(T.clientId).innerBlocks[0].attributes.content=v(j.trimStart()),H=!1):await k(P,j,O,$),j="",D=!1,q=!1),o({reply:F})}},I.onerror=function(e){I.close(),Q()}},_=(0,n.createElement)("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 553.84 552.02"},(0,n.createElement)("path",{fill:"#6f52a2",d:"M.67,.18H371.96c99.34,0,180,80.66,180,180v371.29H180.67C81.32,551.47,.67,470.82,.67,371.47V.18H.67Z"}),(0,n.createElement)("g",null,(0,n.createElement)("path",{fill:"#fff",d:"M243.54,394.07c-23.45,0-43.15-8.03-59.11-24.1-15.96-16.07-23.94-35.83-23.94-59.28s7.98-43.15,23.94-59.11c15.96-15.96,35.66-23.94,59.11-23.94s43.2,7.98,59.28,23.94c16.06,15.96,24.1,35.66,24.1,59.11v60.9c0,6.52-2.07,11.78-6.19,15.8-4.13,4.01-9.45,6.02-15.96,6.02s-11.78-2.01-15.8-6.02c-4.02-4.02-6.02-9.28-6.02-15.8v-60.9c0-10.85-3.86-20.08-11.56-27.68-7.71-7.6-16.99-11.4-27.85-11.4s-20.08,3.8-27.68,11.4c-7.6,7.61-11.4,16.83-11.4,27.68s3.8,20.14,11.4,27.85c7.6,7.71,16.82,11.56,27.68,11.56,6.51,0,11.83,2.01,15.96,6.03,4.12,4.02,6.19,9.28,6.19,15.79s-2.07,11.84-6.19,15.96c-4.13,4.13-9.45,6.19-15.96,6.19Z"}),(0,n.createElement)("path",{fill:"#fff",d:"M385.37,165.93c5.32,5.33,7.98,11.68,7.98,19.06s-2.66,13.74-7.98,19.05c-5.32,5.32-11.67,7.98-19.05,7.98s-13.74-2.66-19.05-7.98c-5.32-5.32-7.98-11.67-7.98-19.05s2.66-13.73,7.98-19.06c5.32-5.32,11.67-7.98,19.05-7.98s13.73,2.66,19.05,7.98Zm3.09,83.54c0-14.54-7.38-21.82-22.15-21.82-6.52,0-11.78,2.01-15.8,6.02-4.02,4.02-6.03,9.28-6.03,15.79v122.13c0,6.52,2.01,11.78,6.03,15.8,4.01,4.01,9.28,6.02,15.8,6.02s11.83-2.01,15.96-6.02c4.12-4.02,6.19-9.28,6.19-15.8v-122.13Z"}))),x=(0,n.createElement)("svg",{width:"135",height:"140",viewBox:"0 0 135 140",xmlns:"http://www.w3.org/2000/svg",fill:"#fff"},(0,n.createElement)("rect",{y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.5s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.5s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"30",y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.25s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.25s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"60",width:"15",height:"140",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"90",y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.25s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.25s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"120",y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.5s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.5s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"}))),S="aiify/aiify",M=window.wp.compose,A=(0,M.createHigherOrderComponent)((e=>t=>{const{name:i,attributes:l,setAttributes:c}=t,{styles:s,tones:d,maxWords:u,style:m,tone:p,languages:g,language:f}=window.aiify;if((e=>b.concat(["aiify/aiify"]).includes(e))(i)&&t.isSelected){const i=e=>{const[t,r]=(0,n.useState)(parseInt(u)),[i,l]=(0,n.useState)(p),[c,w]=(0,n.useState)(m),[h,b]=(0,n.useState)(f);return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(o.RangeControl,{min:0,max:2e3,label:(0,a.__)("Max words to generate","aiify"),help:(0,a.__)("Do not exceed this value","aiify"),value:parseInt(t),onChange:e=>{window.aiify.maxWords=e,r(e)}}),(0,n.createElement)(o.SelectControl,{label:(0,a.__)("Select writing style","aiify"),onChange:e=>{window.aiify.style=e,w(e)},options:s,value:c}),(0,n.createElement)(o.SelectControl,{label:(0,a.__)("Select writing tone","aiify"),onChange:e=>{window.aiify.tone=e,l(e)},options:d,value:i}),(0,n.createElement)(o.SelectControl,{label:(0,a.__)("Select an output language","aiify"),onChange:e=>{window.aiify.language=e,b(e)},options:g,value:h}))};return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(e,t),(0,n.createElement)(r.InspectorControls,null,(0,n.createElement)(o.PanelBody,{icon:_,title:(0,a.__)("Aiify Settings","aiify")},(0,n.createElement)(i,t))))}return(0,n.createElement)(e,t)}),"withPanelControl"),N=(window.wp.data,wp.data.select("core/block-editor").getSelectedBlock),I=e=>{const{attributes:t,name:n,innerBlocks:a=[]}=e,{content:r,level:o}=t||{};if(r)switch(n){case"core/heading":return`${"#".repeat(o)} ${r.replace(/\n+$/,"")}\n`;case"core/list-item":return`- ${r}\n`;case"core/citation":case"core/pullquote":return`> ${r}\n\n`;case"core/code":case"core/verse":return`\`\`\`\n${r}\n\`\`\`\n\n`;default:return`${r}\n\n`}return a.map(I).join("")},F=(0,M.createHigherOrderComponent)((e=>i=>{if(!b.includes(i.name))return(0,n.createElement)(e,i);const[l,c]=(0,n.useState)(!1),[s,d]=(0,n.useState)(!1),[u,m]=(0,n.useState)([]),p=()=>c(!1),g=async(e,t,n)=>{if(void 0===n&&(n=N()),n){d(!0);const a=I(n);C({idBlock:n.clientId,edit:a,prompt:e,setAttributes:()=>console.log,insertAfter:"edit"==t?null:t,onDone:()=>d(!1)})}},f=e=>{let{edits:t,command:r,onClose:i}=e;var l=[];return t.forEach((function(e){l.push({title:e,onClick:t=>{g(e,r),t()}})})),l.push({title:(0,a.__)("Custom edit","aiify"),onClick:e=>{m([r,N()]),c(!0),e()}}),(0,n.createElement)(n.Fragment,null,l.map((e=>(0,n.createElement)(o.MenuItem,{onClick:()=>e.onClick(i)},e.title))))},{attributes:w,setAttributes:h}=i,{edits:y,after:v,before:E}=window.aiify,k=(0,t.applyFilters)("aiify.customModal",(e=>(0,n.createElement)(n.Fragment,null,(0,n.createElement)("p",null,"Decouvrez la version pro"))));return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(r.BlockControls,{group:"block"},(0,n.createElement)(o.ToolbarGroup,null,(0,n.createElement)(o.ToolbarDropdownMenu,{icon:s?x:_,label:(0,a.__)("Aiify me","aiify")},(e=>{let{onClose:t}=e;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(o.MenuGroup,{label:(0,a.__)("Review or edit this block","aiify")},(0,n.createElement)(f,{edits:y,command:"edit",onClose:t})),(0,n.createElement)(o.MenuGroup,{label:(0,a.__)("Generate and prepend based on this block","aiify")},(0,n.createElement)(f,{edits:E,command:"before",onClose:t})),(0,n.createElement)(o.MenuGroup,{label:(0,a.__)("Generate and append based on this block","aiify")},(0,n.createElement)(f,{edits:v,command:"after",onClose:t})))})))),l&&(0,n.createElement)(o.Modal,{title:(0,a.__)("Custom command","aiify"),onRequestClose:p},(0,n.createElement)(k,{generateBlock:g,selectedEdit:u,closeModal:p})),(0,n.createElement)(e,i))}),"withToolbarButton");(0,e.registerBlockType)(S,{icon:{src:_},edit:function(e){let{attributes:t,setAttributes:i}=e;const l=(0,r.useBlockProps)(),[c,s]=(0,n.useState)(!1),{prompts:d}=window.aiify;var u=l.id.split("block-")[1];const m="textarea-"+u;return(0,n.createElement)("div",l,(0,n.createElement)(o.SelectControl,{label:(0,a.__)("Select a content type","aiify"),onChange:e=>{const t=e+' "['+d[e]+']"';i({prompt:t});const n=document.querySelector('[data-id="'+m+'"]');n&&setTimeout((()=>n.focus()),200)},options:(p=d,Object.keys(p).map(((e,t,n)=>({label:e,value:n[t]}))))}),(0,n.createElement)(o.TextareaControl,{"data-id":m,autoFocus:!0,placeholder:(0,a.__)("What do you want to write today?","aiify"),label:"",rows:2,value:t.prompt,onChange:e=>i({prompt:e}),onFocus:e=>{const t=e.target,n=t.value.match(/\"\[([^\]]+)\]\"/);if(n){const e=n.index+1,a=e+n[1].length+2;t.selectionStart=e,t.selectionEnd=a}}}),(0,n.createElement)(o.ButtonGroup,{textAlign:"right"},(0,n.createElement)(o.Button,{isBusy:c,disabled:c,variant:"primary",onClick:()=>{s(!0),C({prompt:t.prompt,idBlock:u,setAttributes:i,onDone:()=>s(!1)})},text:(0,a.__)("Write","aiify")}),(0,n.createElement)(o.Button,{disabled:c,variant:"default",onClick:()=>y(u),text:(0,a.__)("Clear","aiify")})),(0,n.createElement)(r.InnerBlocks,{allowedBlocks:["core/image","core/group","core/paragraph","core/quote","core/code","core/pullquote","core/list","core/list-item","core/heading","core/verse","wp-gb/inner-blocks"]}));var p},save:function(e){let{attributes:t}=e;return(0,n.createElement)("div",r.useBlockProps.save(),(0,n.createElement)(r.InnerBlocks.Content,null))},transforms:{from:[{type:"enter",regExp:/^ai$/i,transform:()=>w(S)}],to:[{type:"block",blocks:["core/group"],transform:(e,t)=>w("core/group",e,t)}]}}),(0,t.addFilter)("editor.BlockEdit","ai-panel",A),(0,t.addFilter)("editor.BlockEdit","ai-toolbar",F),(0,t.addFilter)("blocks.getBlockAttributes","paragraph_prompt",((e,t)=>("core/paragraph"==t.name&&(e.placeholder=window.aiify.paragraphPrompt),e)))})();